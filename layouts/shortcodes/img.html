{{- $image := .Page.Resources.GetMatch (.Get "src") -}}
{{- $width := .Get "width" -}}
{{- $alt := .Get "alt" | default "" -}}
{{- $caption := .Get "caption" | default "" -}}

{{- if $image -}}
  {{- $webp := "" -}}
  {{- if $width -}}
    {{- $processed := $image.Resize (printf "%sx" $width) -}}
    {{- $webp = $processed.Process "webp" -}}
  {{- else -}}
    {{- $webp = $image.Process "webp" -}}
  {{- end -}}
  
  <figure{{ if or (.Get "class") (eq (.Get "align") "center") }} class="
             {{- if eq (.Get "align") "center" }}align-center {{ end }}
             {{- with .Get "class" }}{{ . }}{{- end }}"
  {{- end -}}>
    {{- if .Get "link" -}}
        <a href="{{ .Get "link" }}"{{ with .Get "target" }} target="{{ . }}"{{ end }}{{ with .Get "rel" }} rel="{{ . }}"{{ end }}>
    {{- end }}
    <img loading="lazy" src="{{ $webp.RelPermalink }}"
         {{- if $alt }} alt="{{ $alt }}"{{ end -}}
         {{- with .Get "width" }} width="{{ . }}"{{ end -}}
         {{- with .Get "height" }} height="{{ . }}"{{ end -}}
    />
    {{- if .Get "link" }}</a>{{ end -}}
    {{- if $caption -}}
        <figcaption>{{ $caption }}</figcaption>
    {{- end }}
  </figure>
{{- else -}}
  <p style="color: red;">画像が見つかりません: {{ .Get "src" }}</p>
{{- end -}} 