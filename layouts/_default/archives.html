{{- define "main" }}
<div class="bg-white">
  <div class="container mx-auto px-4 py-12">
    <div class="mb-4">
      <a href="{{ "/" | relLangURL }}" class="text-sm text-gray-500 hover:text-gray-700">{{ i18n "back_home" }}</a>
    </div>
    <h1 class="text-2xl font-medium text-gray-900 mb-8">{{ i18n "archive_list_title" }}</h1>

    {{/* 元の構造を保持、フィルター条件のみ修正 */}}
    {{ $allPages := where (where .Site.RegularPages "Layout" "ne" "search") "Params.searchHidden" "ne" true }}
    {{ $monthMap := dict }}
    {{ range $allPages }}
      {{ $raw := (partial "extract-date.html" . | plainify | printf "%s") }}
      {{ $dStr := (cond (ne $raw "") $raw (.Date.Format "2006-01-02")) }}
      {{ $d := time $dStr }}
      {{ $mKey := $d.Format "2006-01" }}
      {{ $pages := index $monthMap $mKey | default slice }}
      {{ $pages = $pages | append . }}
      {{ $monthMap = merge $monthMap (dict $mKey $pages) }}
    {{ end }}

    {{/* 月キーをソート (新しい順) */}}
    {{/* 年別に月情報をまとめる */}}
    {{ $yearMap := dict }}
    {{ range $mk, $pgs := $monthMap }}
      {{ $yr := substr $mk 0 4 }}
      {{ $mDict := index $yearMap $yr | default dict }}
      {{ $mDict = merge $mDict (dict $mk $pgs) }}
      {{ $yearMap = merge $yearMap (dict $yr $mDict) }}
    {{ end }}

    {{/* 年キーをソート (新しい順) */}}
    {{ $yrs := slice }}
    {{ range $y, $_ := $yearMap }}
      {{ $yrs = $yrs | append $y }}
    {{ end }}
    {{ $sortedYrs := sort $yrs }}

    <div class="space-y-2">
      {{ range $j := seq (sub (len $sortedYrs) 1) 0 }}
        {{ $yr := index $sortedYrs $j }}
        {{ $monthsDict := index $yearMap $yr }}
        {{ $mKeys := slice }}
        {{ range $mk, $_ := $monthsDict }}
          {{ $mKeys = $mKeys | append $mk }}
        {{ end }}
        {{ $mSorted := sort $mKeys }}
        <div class="flex items-center flex-wrap text-sm py-1 border-b border-gray-100 last:border-b-0">
          <span class="font-medium text-gray-900 mr-4">{{ cond (eq $.Site.Language.Lang "en") $yr (print $yr "年") }}</span>
          {{ range $mSorted }}
            {{ $pgs := index $monthsDict . }}
            {{ $sample := index $pgs 0 }}
            {{ $rd := (partial "extract-date.html" $sample | plainify | printf "%s") }}
            {{ $ds := (cond (ne $rd "") $rd ($sample.Date.Format "2006-01-02")) }}
            {{ $pd := time $ds }}
            <a href="{{ (print "/months/" . "/") | relLangURL }}" class="px-2 py-1 mr-2 mb-1 bg-gray-100 rounded text-gray-700 hover:bg-gray-200 hover:text-gray-900 transition-colors">
              {{ cond (eq $.Site.Language.Lang "en") ($pd.Format "Jan") ($pd.Format "1月") }}<span class="text-gray-500">({{ len $pgs }})</span>
            </a>
          {{ end }}
        </div>
      {{ end }}
    </div>

    <!-- Advertisement Area -->
    <div class="h-48 mt-12 bg-gray-50 border border-gray-200 rounded flex items-center justify-center">
      <span class="text-gray-400 text-xs">広告</span>
    </div>
  </div>
</div>
{{- end }}
