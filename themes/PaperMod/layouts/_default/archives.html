{{- define "main" }}

<header class="page-header">
  <h1>
    {{ .Title }}
    {{- if (.Param "ShowRssButtonInSectionTermList") }}
    {{- $rss := (.OutputFormats.Get "rss") }}
    {{- if (eq .Kind `page`) }}
    {{- $rss = (.Parent.OutputFormats.Get "rss") }}
    {{- end }}
    {{- with $rss }}
    <a href="{{ .RelPermalink }}" title="RSS" aria-label="RSS">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round" height="23">
        <path d="M4 11a9 9 0 0 1 9 9" />
        <path d="M4 4a16 16 0 0 1 16 16" />
        <circle cx="5" cy="19" r="1" />
      </svg>
    </a>
    {{- end }}
    {{- end }}
  </h1>
  {{- if .Description }}
  <div class="post-description">
    {{ .Description }}
  </div>
  {{- end }}
</header>

{{/* TOPページと完全に同じロジックを使用 */}}
{{ $allPages := where (where .Site.RegularPages "Layout" "ne" "search") "Params.searchHidden" "ne" true }}
{{ $monthMap := dict }}
{{ range $allPages }}
  {{ $partialDate := (partial "extract-date.html" . | plainify | printf "%s") }}
  {{ $dateStr := (cond (ne $partialDate "") $partialDate (.Date.Format "2006-01-02")) }}
  {{ $postDate := time $dateStr }}
  {{ $monthKey := $postDate.Format "2006-01" }}
  {{ $pages := index $monthMap $monthKey | default slice }}
  {{ $pages = $pages | append . }}
  {{ $monthMap = merge $monthMap (dict $monthKey $pages) }}
{{ end }}

{{/* 年別に月情報をまとめる */}}
{{ $yearMap := dict }}
{{ range $monthKey, $monthPages := $monthMap }}
  {{ $year := substr $monthKey 0 4 }}
  {{ $monthDict := index $yearMap $year | default dict }}
  {{ $monthDict = merge $monthDict (dict $monthKey $monthPages) }}
  {{ $yearMap = merge $yearMap (dict $year $monthDict) }}
{{ end }}

{{/* 年キーをソート (新しい順) */}}
{{ $years := slice }}
{{ range $year, $_ := $yearMap }}
  {{ $years = $years | append $year }}
{{ end }}
{{ $sortedYears := sort $years }}

{{- range $i := seq (sub (len $sortedYears) 1) 0 }}
  {{ $year := index $sortedYears $i }}
  {{ $monthsDict := index $yearMap $year }}
  {{ $monthKeys := slice }}
  {{ range $monthKey, $_ := $monthsDict }}
    {{ $monthKeys = $monthKeys | append $monthKey }}
  {{ end }}
  {{ $sortedMonths := sort $monthKeys }}
  
<div class="archive-year">
  <h2 class="archive-year-header" id="{{ $year }}">
    <a class="archive-header-link" href="#{{ $year }}">
      {{- $year -}}
    </a>
    <sup class="archive-count">&nbsp;{{ $totalPagesCount := 0 }}{{ range $monthKey := $sortedMonths }}{{ $monthPages := index $monthsDict $monthKey }}{{ $totalPagesCount = add $totalPagesCount (len $monthPages) }}{{ end }}{{ $totalPagesCount }}</sup>
  </h2>
  
  {{- range $j := seq (sub (len $sortedMonths) 1) 0 }}
    {{ $monthKey := index $sortedMonths $j }}
    {{ $monthPages := index $monthsDict $monthKey }}
    {{ $firstPage := index $monthPages 0 }}
    {{ $partialDate := (partial "extract-date.html" $firstPage | plainify | printf "%s") }}
    {{ $dateStr := (cond (ne $partialDate "") $partialDate ($firstPage.Date.Format "2006-01-02")) }}
    {{ $parsedDate := time $dateStr }}
    {{ $monthName := $parsedDate.Format "January" }}
    
  <div class="archive-month">
    <h3 class="archive-month-header" id="{{ $year }}-{{ $monthName }}">
      <a class="archive-header-link" href="#{{ $year }}-{{ $monthName }}">
        {{- $monthName -}}
      </a>
      <sup class="archive-count">&nbsp;{{ len $monthPages }}</sup>
    </h3>
    <div class="archive-posts">
      {{- range $monthPages }}
      {{- if eq .Kind "page" }}
      <div class="archive-entry">
        <h3 class="archive-entry-title entry-hint-parent">
          {{- .Title | markdownify }}
          {{- if .Draft }}
          <span class="entry-hint" title="Draft">
            <svg xmlns="http://www.w3.org/2000/svg" height="15" viewBox="0 -960 960 960" fill="currentColor">
              <path
                d="M160-410v-60h300v60H160Zm0-165v-60h470v60H160Zm0-165v-60h470v60H160Zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22q0 11-4.5 22.5T862.09-380L643-160H520Zm300-263-37-37 37 37ZM580-220h38l121-122-18-19-19-18-122 121v38Zm141-141-19-18 37 37-18-19Z" />
            </svg>
          </span>
          {{- end }}
        </h3>
        <div class="archive-meta">
          {{- partial "post_meta.html" . -}}
        </div>
        <a class="entry-link" aria-label="post link to {{ .Title | plainify }}" href="{{ .Permalink }}"></a>
      </div>
      {{- end }}
      {{- end }}
    </div>
  </div>
  {{- end }}
</div>
{{- end }}

{{- end }}{{/* end main */}}
