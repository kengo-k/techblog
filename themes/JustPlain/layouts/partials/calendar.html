<!-- Calendar Component -->
<div class="calendar-container">
  <div id="calendar" class="bg-white p-2"></div>
</div>

<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const calendarEl = document.getElementById("calendar");

    // JSONを取得してからカレンダー構築
    fetch('{{ "/calendar-data.json" | relLangURL }}' + "?v=" + Date.now())
      .then((response) => response.json())
      .then((calendarData) => {
        console.log(calendarData);

        // 記事がある日付をFullCalendar用のイベントデータに変換（背景色なし）
        const events = [];

        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "dayGridMonth",
          headerToolbar: {
            left: "prev,next",
            center: "title",
            right: "",
          },
          locale: "en",
          firstDay: 0, // 日曜始まりに統一
          height: "auto",
          fixedWeekCount: false,
          showNonCurrentDates: false,
          dayHeaderFormat: { weekday: "short" },
          dayCellContent: function (info) {
            return info.date.getDate();
          },
          events: events,
          dateClick: function (info) {
            // 記事がある日付がクリックされた場合の処理
            const year = info.date.getFullYear();
            const month = String(info.date.getMonth() + 1).padStart(2, "0");
            const day = String(info.date.getDate());
            const monthKey = `${year}${month}`;

            const daysInMonth = calendarData[monthKey] || [];
            if (daysInMonth.includes(day)) {
              // 該当日の記事一覧ページにリダイレクト
              const dayPadded = day.padStart(2, "0");
              const url = `{{ "/" | relLangURL }}posts/${year}${month}/${dayPadded}/`;
              window.location.href = url;
            }
          },
          dayCellDidMount: function (info) {
            // 記事がある日付にマーカーを追加
            const year = info.date.getFullYear();
            const month = String(info.date.getMonth() + 1).padStart(2, "0");
            const day = String(info.date.getDate()).padStart(2, "0");
            const monthKey = `${year}${month}`;

            // JSONから該当月の日付配列を取得してYYYY-MM-DD形式にマップ
            const daysInMonth = calendarData[monthKey] || [];
            const fullDates = daysInMonth.map(
              (d) => `${year}-${month}-${d.padStart(2, "0")}`
            );
            const dateStr = `${year}-${month}-${day}`;

            if (fullDates.includes(dateStr)) {
              console.log("Match found for day:", day);
              const dayEl = info.el;
              dayEl.style.position = "relative";

              // 日付を囲む丸いマーカーを追加
              const marker = document.createElement("div");
              marker.className = "article-marker";
              marker.style.cssText = `
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-60%, -50%);
          width: 20px;
          height: 20px;
          background-color: #93c5fd;
          border-radius: 50%;
          z-index: 0;
        `;
              dayEl.appendChild(marker);

              // 記事がある日の数字を白色に変更
              const dayNumber = dayEl.querySelector(".fc-daygrid-day-number");
              if (dayNumber) {
                dayNumber.style.color = "#ffffff";
                dayNumber.style.fontWeight = "600";
              }

              // ホバー効果
              dayEl.style.cursor = "pointer";
              dayEl.addEventListener("mouseenter", function () {
                dayEl.style.backgroundColor = "#f3f4f6";
              });
              dayEl.addEventListener("mouseleave", function () {
                dayEl.style.backgroundColor = "";
              });
            }
          },
        });

        calendar.render();
      })
      .catch((error) => {
        console.error("Calendar data not found:", error);
      });
  });
</script>

<style>
  /* カレンダーのカスタムスタイル */
  .fc-theme-standard .fc-scrollgrid {
    border: none;
  }

  .fc-theme-standard td,
  .fc-theme-standard th {
    border-color: #f3f4f6;
    border-width: 1px;
  }

  .fc-col-header-cell {
    background-color: #f9fafb;
  }

  .fc-col-header-cell-cushion {
    font-size: 0.65rem;
    color: #6b7280;
  }

  .fc-daygrid-day-number {
    color: #6b7280;
    font-weight: 400;
    font-size: 0.65rem;
  }

  .fc-day-today {
    background-color: transparent !important;
  }

  .fc-button {
    background-color: transparent;
    border: none;
    color: #6b7280;
    padding: 1px 3px;
    font-size: 10px !important;
    font-weight: 400;
    line-height: 1.2;
  }

  .fc-button:hover {
    background-color: #f3f4f6;
    color: #374151;
  }

  .fc-button:disabled {
    background-color: transparent;
    color: #d1d5db;
  }

  .fc-toolbar-title {
    color: #374151;
    font-size: 11px !important;
    font-weight: 500;
    line-height: 1.2;
  }

  .fc .fc-toolbar.fc-header-toolbar {
    margin-bottom: 0.5em !important;
  }

  .fc-daygrid-day {
    height: 20px !important;
    width: 20px !important;
  }

  .fc-daygrid-day-frame {
    min-height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .fc-daygrid-day-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
  }
</style>
